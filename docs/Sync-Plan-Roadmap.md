# 同步能力差距分析与需求计划（对标 Syncthing / rsync）

本文是 GoHook 当前同步方案的“缺陷清单 + 实现需求点 + 迭代计划”，用于后续排期与验收。

> 总体目标：**正确性优先**，在保证最终一致性的前提下提升常态性能（小变更低开销、长时间运行可自愈）。

---

## 1. 现状概述（当前实现）

### 1.1 角色模型与同步语义

- 主节点：权威数据源，负责生成索引与提供块数据。
- 子节点（Agent）：只接收（单向），按主节点索引落盘。
- 策略：
  - `mirror`：目标应与源一致（含删除额外文件）。
  - `overlay`：只覆盖/新增，不做远端删除（目标可保留额外内容）。

### 1.2 传输与一致性手段

- 块级同步：固定块（自适应块大小）+ SHA-256 块哈希校验。
- TCP/TLS 长连接：任务下发与块传输。
- 可靠性：
  - Agent 写入前校验块哈希，避免静默写坏。
  - 任务超时与可重试错误自动进入 `retrying`（上限可配）。

### 1.3 性能优化现状

- Agent：无缺块时跳过临时文件；缺块时 temp 原子替换并优先 reflink/copy seed。
- 主节点：块哈希缓存减少重复 hash。
- 增量能力：
  - Overlay 可选“增量索引”（从 `sync_file_changes` 拉取未处理变更，仅下发变更文件索引）。
  - Mirror 可选“manifest 增量删除”（不全量 Walk，周期性可回退严格扫描）。
- 协议升级：可选 Chunked Index（分批索引与块服务）降低峰值内存并提前落盘。
- 配置方式：核心同步参数通过 UI 写入 `version.yaml`（类似 Syncthing 的 GUI 配置），环境变量仅作为运维覆盖/应急手段。

---

## 2. 对标 Syncthing / rsync 的主要差距与风险

### 2.1 “漂移自愈”能力不足（最终一致性风险）

**定义：漂移（drift）** 指子节点因人为/程序/磁盘问题产生的偏离：文件被删除、被改坏、部分写入、权限/时间被改等。

- rsync 的单向模型：只要再次运行并包含该路径，就会覆盖恢复（配合 `--delete` 可删除额外文件）。
- Syncthing：Watcher 只是加速，核心依赖**定时重新扫描**与索引对比来纠偏，保证最终一致性。

**当前风险点（需要重点关注）：**

1) **Overlay 增量索引模式下，漂移可能不自愈**
   - 当启用“仅下发变更文件索引”时：
     - 主节点文件未变化；
     - 子节点把文件删除/改坏；
     - 主节点变更队列不会包含该文件；
     - 本轮任务不会给该文件下发索引；
     - 子节点无法请求缺块 ⇒ **无法自动恢复**。

2) Watcher/事件队列天然不可靠
   - 常见原因：事件丢失、队列溢出、网络盘/容器卷不稳定、重命名风暴、进程重启期间的变更未入队。
   - 若系统过度依赖“事件驱动增量”，会出现“某些文件长期不同步”的隐性问题。

### 2.2 断点续传/任务续跑能力不足（稳定性与成本）

- rsync/syncthing 通常会尽量复用已完成传输或状态，失败后不会完全从头来。
- 当前实现失败后重试会重跑任务（块级可减少传输，但索引与本地计算仍可能重做）。

### 2.3 文件语义覆盖不足（兼容性差距）

- 目录/空目录：mirror 语义往往要求空目录也被复现；当前更多以文件为主。
- 符号链接/特殊文件：成熟方案一般有明确策略（同步/忽略/转普通文件）。
- 权限/属主/时间：已支持 `ignore_permissions`，但对 owner/group、ACL 等尚未形成一致策略。

### 2.4 流控与并发（吞吐差距）

- 当前块请求主要为串行（有 batch，但仍按响应顺序处理），吞吐在高 RTT 下受限。
- Syncthing 有更强的 pipeline/并发能力；rsync 也会通过滚动校验与网络 pipeline 提高效率。

---

## 3. 需求点（实现需求 / 规则）

本节是“必须实现/必须明确”的需求点，作为后续开发验收标准。

### R1：最终一致性（漂移可自愈）

- R1.1 子节点文件被删除/改坏/部分写入后，必须能在合理时间内**自动恢复**（不要求实时，但要可证明最终一致）。
- R1.2 增量模式不能引入“永远不同步”的隐性风险；必须有纠偏机制。

### R2：健壮性（长期运行）

- R2.1 允许 watcher 漏事件、进程重启、短暂断网；系统应能自恢复并最终一致。
- R2.2 失败必须可诊断（稳定 errorCode），且不能出现“任务成功但文件损坏”的静默错误。

### R3：性能（常态小变更低成本）

- R3.1 小变更时避免全量扫描/全量 hash/全量落盘。
- R3.2 大项目多节点场景：重复计算应尽量缓存复用。
- R3.3 网络高延迟场景：支持一定程度的 pipeline/并发，提高吞吐。

### R4：语义明确（mirror/overlay）

- R4.1 `mirror`：在“严格模式”下必须能删除目标端额外文件并可选清理空目录。
- R4.2 `overlay`：默认不传播删除，但必须能纠偏“目标端误删/损坏”的文件（通过基线校验实现）。
- R4.3 对 symlink/特殊文件/空目录要明确支持范围与行为（即使先选择不支持，也必须文档化）。

---

## 4. 计划方案（分阶段迭代）

> 原则：先补“最终一致性闭环”，再做吞吐与编码优化。

### Phase A：为增量模式补齐“基线校验/重新扫描”

**目标：** 对标 Syncthing 的“定时重新扫描”思想，保证 overlay 增量模式下子节点漂移可自愈。

状态：✅ 已完成最小闭环（基线全量 + 目标端缺失路径主动补索引）。

待完善/可优化：
- Overlay 增量索引的“纠偏”增加抽样校验：随机抽查（路径/目录维度）发现漂移后主动 `index_need`。
- `.gohook-sync-expected.json` 增加 compact/分段存储与上限策略（超大项目避免文件过大、避免频繁重写）。
- 明确“基线扫描触发条件”的优先级与可观测性（日志/状态字段），便于运维判断是否在按预期纠偏。

### Phase B：任务续跑/断点续传（稳定性与成本）

**目标：** 失败重试尽量复用已完成工作。

状态：✅ 已完成最小闭环（单文件 partial + checkpoint，断线/重启可续跑）。

待完善/可优化：
- checkpoint 清理策略：任务成功/失败后，对旧 `.gohook-sync-tmp-partial*` 做 TTL/容量上限回收，避免磁盘累积。
- “任务级”续跑状态（可选）：把已完成文件集合、失败点、统计等写入 Agent DataDir，重试时减少重复计算（尤其是小文件/目录结构处理）。
- 明确 server 侧幂等：失败重试是否沿用 taskId、attempt 行为是否需要更严格的生命周期（避免重复计数/重复执行）。

验收：
- 人为制造断网/超时，恢复后重试总耗时显著小于从头跑。

### Phase C：吞吐提升（并发/窗口化）

**目标：** 在高 RTT 与大文件场景提升块拉取吞吐。

状态：✅ 已完成最小闭环（自适应 batch + server 写 deadline 加固）。

待完善/可优化（建议优先级从上到下）：
- 协议 `requestId`：允许并发/乱序响应，Agent 侧实现“窗口化并发”（按并发度与内存上限做 backpressure）。
- 分级并发：文件级并发（多文件同时拉块）+ 块级并发（单文件窗口），并提供全局限流（带宽/IO）。
- 观测指标：吞吐、RTT、in-flight block、重试次数、平均 batch 大小，便于压测与回归。

验收：
- 高 RTT（例如 80–150ms）下，吞吐相对串行版本显著提升。

### Phase D：文件语义补齐与边界策略

**目标：** 明确并逐步补齐与 rsync/Syncthing 接近的文件语义。

状态：✅ 已完成最小闭环（空目录、symlink 策略、权限/mtime 拆分 + UI 权限 Tab）。

待完善/可优化：
1) owner/group（Linux only）
   - 策略：默认不改 owner/group；可选开启并明确需要的 capability/权限；避免提权风险。
2) ACL/扩展属性（可选）
   - 明确支持范围（Linux only / 同文件系统）与失败降级策略（忽略/失败）。
3) symlink 安全策略
   - 是否允许绝对链接/跨目录链接；是否需要限制为“相对且不逃逸 targetRoot”（避免潜在安全坑）。
4) 特殊文件/硬链接/设备文件
   - 明确同步/忽略策略；先文档化，再决定是否实现。
5) 目录元数据一致性
   - 目录的 mode/mtime 是否需要完整对齐（当前仅在创建时 best-effort）；需要明确语义与实现成本。

---


## 6. 下一步建议（跨 Phase 优先级）

P0（优先做，收益大/风险低）：
- Phase C：引入 `requestId` + 乱序响应，做窗口化并发与全局限流（带宽/IO/内存），并加基础指标。
- Phase D：明确并实现 symlink 安全策略（是否允许绝对/逃逸链接；默认应保守），补齐文档与错误码。
- Phase B：为 partial/checkpoint 加回收策略（TTL/容量上限），避免磁盘长期累积。

P1（中期做，面向运维/一致性）：
- Phase A：抽样漂移校验（按目录/按概率）+ 主动 `index_need`，缩短“漂移纠偏时间”。
- Phase C：压测基准与回归指标（RTT 维度、文件大小分布维度），让吞吐优化可验收。

P2（长线做，语义兼容）：
- Phase D：owner/group、ACL/xattr、特殊文件（设备/pipe）策略逐项落地（先文档化，再实现/明确不支持）。
