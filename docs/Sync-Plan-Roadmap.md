# 同步能力差距分析与需求计划（对标 Syncthing / rsync）

本文是 GoHook 当前同步方案的“缺陷清单 + 实现需求点 + 迭代计划”，用于后续排期与验收。

> 总体目标：**正确性优先**，在保证最终一致性的前提下提升常态性能（小变更低开销、长时间运行可自愈）。

---

## 1. 现状概述（当前实现）

### 1.1 角色模型与同步语义

- 主节点：权威数据源，负责生成索引与提供块数据。
- 子节点（Agent）：只接收（单向），按主节点索引落盘。
- 策略：
  - `mirror`：目标应与源一致（含删除额外文件）。
  - `overlay`：只覆盖/新增，不做远端删除（目标可保留额外内容）。

### 1.2 传输与一致性手段

- 块级同步：固定块（自适应块大小）+ SHA-256 块哈希校验。
- TCP/TLS 长连接：任务下发与块传输。
- 可靠性：
  - Agent 写入前校验块哈希，避免静默写坏。
  - 任务超时与可重试错误自动进入 `retrying`（上限可配）。

### 1.3 性能优化现状

- Agent：无缺块时跳过临时文件；缺块时 temp 原子替换并优先 reflink/copy seed。
- 主节点：块哈希缓存减少重复 hash。
- 增量能力：
  - Overlay 可选“增量索引”（从 `sync_file_changes` 拉取未处理变更，仅下发变更文件索引）。
  - Mirror 可选“manifest 增量删除”（不全量 Walk，周期性可回退严格扫描）。
- 协议升级：可选 Chunked Index（分批索引与块服务）降低峰值内存并提前落盘。
- 配置方式：核心同步参数通过 UI 写入 `version.yaml`（类似 Syncthing 的 GUI 配置），环境变量仅作为运维覆盖/应急手段。

---

## 2. 对标 Syncthing / rsync 的主要差距与风险

### 2.1 “漂移自愈”能力不足（最终一致性风险）

**定义：漂移（drift）** 指子节点因人为/程序/磁盘问题产生的偏离：文件被删除、被改坏、部分写入、权限/时间被改等。

- rsync 的单向模型：只要再次运行并包含该路径，就会覆盖恢复（配合 `--delete` 可删除额外文件）。
- Syncthing：Watcher 只是加速，核心依赖**定时重新扫描**与索引对比来纠偏，保证最终一致性。

**当前风险点（需要重点关注）：**

1) **Overlay 增量索引模式下，漂移可能不自愈**
   - 当启用“仅下发变更文件索引”时：
     - 主节点文件未变化；
     - 子节点把文件删除/改坏；
     - 主节点变更队列不会包含该文件；
     - 本轮任务不会给该文件下发索引；
     - 子节点无法请求缺块 ⇒ **无法自动恢复**。

2) Watcher/事件队列天然不可靠
   - 常见原因：事件丢失、队列溢出、网络盘/容器卷不稳定、重命名风暴、进程重启期间的变更未入队。
   - 若系统过度依赖“事件驱动增量”，会出现“某些文件长期不同步”的隐性问题。

### 2.2 断点续传/任务续跑能力不足（稳定性与成本）

- rsync/syncthing 通常会尽量复用已完成传输或状态，失败后不会完全从头来。
- 当前实现失败后重试会重跑任务（块级可减少传输，但索引与本地计算仍可能重做）。

### 2.3 文件语义覆盖不足（兼容性差距）

- 目录/空目录：mirror 语义往往要求空目录也被复现；当前更多以文件为主。
- 符号链接/特殊文件：成熟方案一般有明确策略（同步/忽略/转普通文件）。
- 权限/属主/时间：已支持 `ignore_permissions`，但对 owner/group、ACL 等尚未形成一致策略。

### 2.4 流控与并发（吞吐差距）

- 当前块请求主要为串行（有 batch，但仍按响应顺序处理），吞吐在高 RTT 下受限。
- Syncthing 有更强的 pipeline/并发能力；rsync 也会通过滚动校验与网络 pipeline 提高效率。

---

## 3. 需求点（实现需求 / 规则）

本节是“必须实现/必须明确”的需求点，作为后续开发验收标准。

### R1：最终一致性（漂移可自愈）

- R1.1 子节点文件被删除/改坏/部分写入后，必须能在合理时间内**自动恢复**（不要求实时，但要可证明最终一致）。
- R1.2 增量模式不能引入“永远不同步”的隐性风险；必须有纠偏机制。

### R2：健壮性（长期运行）

- R2.1 允许 watcher 漏事件、进程重启、短暂断网；系统应能自恢复并最终一致。
- R2.2 失败必须可诊断（稳定 errorCode），且不能出现“任务成功但文件损坏”的静默错误。

### R3：性能（常态小变更低成本）

- R3.1 小变更时避免全量扫描/全量 hash/全量落盘。
- R3.2 大项目多节点场景：重复计算应尽量缓存复用。
- R3.3 网络高延迟场景：支持一定程度的 pipeline/并发，提高吞吐。

### R4：语义明确（mirror/overlay）

- R4.1 `mirror`：在“严格模式”下必须能删除目标端额外文件并可选清理空目录。
- R4.2 `overlay`：默认不传播删除，但必须能纠偏“目标端误删/损坏”的文件（通过基线校验实现）。
- R4.3 对 symlink/特殊文件/空目录要明确支持范围与行为（即使先选择不支持，也必须文档化）。

---

## 4. 计划方案（分阶段迭代）

> 原则：先补“最终一致性闭环”，再做吞吐与编码优化。

### Phase A：为增量模式补齐“基线校验/重新扫描”（建议优先实现）

**目标：** 对标 Syncthing 的“定时重新扫描”思想，保证 overlay 增量模式下子节点漂移可自愈。

建议实现最小闭环（任选其一或组合）：

1) **周期性全量索引（Overlay 专用）**
   - 配置建议：
     - `SYNC_OVERLAY_FULLSCAN_EVERY=N`：每 N 次任务强制全量 `StreamIndex`
     - 或 `SYNC_OVERLAY_FULLSCAN_INTERVAL=30m`：每 30 分钟至少全量一次
   - 行为：
     - 常态走增量索引；
     - 到点/到次数强制全量索引 ⇒ 子节点缺失文件会再次出现在索引中，从而被恢复。
   - 验收：
     - 在增量模式下，子节点删除任意未变更文件，下一次基线扫描后可恢复。

2) **基于 manifest 的目标端自查（可选增强）**
   - 目标端保存“上次成功同步的文件集合/指纹”，运行时随机抽查或按目录抽查：
     - 若发现缺失/哈希不匹配 ⇒ 主动请求“补发这些路径的索引”
   - 需要协议扩展（新消息类型），复杂度更高，但修复漂移更快。
   - 已实现（最小版本）：
     - 目标端在任务成功后写入 `.gohook-sync-expected.json`（保存上次索引的文件路径集合）
     - 下次同步开始时若发现这些路径在目标端缺失，会发送 `index_need(taskId, paths[])` 给主节点
     - 主节点在生成索引时强制包含这些路径（即使启用了增量索引也会补发索引条目）

### Phase B：任务续跑/断点续传（稳定性与成本）

**目标：** 失败重试尽量复用已完成工作。

已实现（最小闭环）：
- Agent 端对单文件使用固定 partial 文件 `<dst>.gohook-sync-tmp-partial`，断线/重启后可继续在该文件上补齐缺块。
- 同目录写入 checkpoint `<dst>.gohook-sync-tmp-partial.json`（记录 block 列表指纹 + 已完成 block 位图），重试时优先按 checkpoint 计算缺块；在 finalize（rename）前做全块校验，保证正确性。

候选方向：
- 为单次任务引入“已完成文件/缺块列表”的本地状态（可保存在目标端 data-dir），重试时优先复用。
- 或服务端允许 task 在 retrying 时继续同一 taskId（需要更明确的幂等与生命周期管理）。

验收：
- 人为制造断网/超时，恢复后重试总耗时显著小于从头跑。

### Phase C：吞吐提升（并发/窗口化）

**目标：** 在高 RTT 与大文件场景提升块拉取吞吐。

已实现（最小闭环）：
- Agent 端按 `blockSize` 做自适应 “batch/window”（默认目标约 32MiB/批，且限制在 8–256），减少高 RTT 下的往返次数；可用 `SYNC_BLOCK_BATCH_SIZE` 固定批大小，或用 `SYNC_BLOCK_BATCH_TARGET_BYTES` 调整目标字节数。
- 主节点在发送 `block_batch_request` 的响应时按“每个 block”刷新写入 deadline，避免大批次响应被固定 2 分钟 deadline 误杀。

候选方向：
- 在协议中引入 `requestId` 或类似机制，允许并发请求/乱序响应而不破坏帧协议。
- Agent 端实现“窗口化并发”（限制并发度、限制内存、按文件/按块队列）。

验收：
- 高 RTT（例如 80–150ms）下，吞吐相对串行版本显著提升。

### Phase D：文件语义补齐与边界策略

**目标：** 明确并逐步补齐与 rsync/Syncthing 接近的文件语义。

建议优先顺序：
1) 空目录（mirror 可选清理/创建）
2) symlink（同步/忽略/转普通文件，三选一并文档化）
3) owner/group（Linux only，明确 capability 与安全策略）
4) ACL/扩展属性（可选，复杂度高）

---

## 5. 是否需要实现“定时重新扫描”？结论

**需要（推荐实现）**，前提是项目要长期运行且启用增量优化（尤其是 overlay delta）。

原因：
- watcher/队列不可避免会漏事件；
- 子节点漂移不会自动产生主节点变更事件；
- 没有基线扫描会出现“长期隐性不同步”的风险。

推荐做法：
- 将“定时/定次基线扫描”设计为 **可配置、默认保守** 的机制：
  - 默认仍可保持全量索引模式（最强一致、成本高）；
  - 运营侧在启用增量模式时同时启用基线扫描（以换取最终一致性保证）。
